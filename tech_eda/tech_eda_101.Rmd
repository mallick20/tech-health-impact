---
title: "Untitled"
author: "Sanjana Umesh Sawant"
date: "2025-05-04"
output: html_document
---

```{r}
knitr::opts_chunk$set(echo = TRUE)
library(rvest)

download_ntia_datasets <- function(url = "https://www.ntia.gov/page/download-ntia-internet-use-survey-datasets",
                                   file_types = c("csv.zip"),
                                   download_dir = ".") {
  page <- read_html(url)
  links <- html_attr(html_nodes(page, "a"), "href")
  
  # Filter for dataset file types
  dataset_links <- links[grepl(paste(file_types, collapse = "|"), links, ignore.case = TRUE)]
  
  # Define allowed two-digit odd years between 01 and 23
  allowed_years <- sprintf("%02d", seq(1, 23, by = 2))  # "01", "03", ..., "23"
  
  # Further filter: Only keep datasets from allowed years
  filtered_links <- dataset_links[sapply(dataset_links, function(link) {
    two_digit_years <- regmatches(link, gregexpr("\\d{2}", link))[[1]]
    any(two_digit_years %in% allowed_years)
  })]
  
  # Make full URLs and download
  for (link in filtered_links) {
    full_link <- ifelse(grepl("^http", link), link, paste0("https://www.ntia.gov", link))
    file_name <- basename(full_link)
    dest_path <- file.path(download_dir, file_name)
    
    message("Downloading (years 01-23, odd only): ", file_name)
    tryCatch({
      download.file(full_link, destfile = dest_path, mode = "wb")
    }, error = function(e) {
      warning("Failed to download: ", file_name)
    })
  }
}

download_ntia_datasets()  # Now downloads only odd years from 01 to 23

unzip_ntia_files <- function(zip_dir = ".", unzip_dir = tempfile()) {
  zip_files <- list.files(zip_dir, pattern = "\\.zip$", full.names = TRUE)
  
  if (length(zip_files) == 0) {
    stop("No zip files found in the specified directory.")
  }
  
  if (!dir.exists(unzip_dir)) {
    dir.create(unzip_dir)
  }
  
  for (zip_path in zip_files) {
    message("Unzipping: ", basename(zip_path))
    unzip(zip_path, exdir = unzip_dir)
  }
  
  return(unzip_dir)  # Return the path where files were unzipped
}
unzipped_folder <- unzip_ntia_files(zip_dir = ".", unzip_dir = "unzipped_ntia_files")

read_ntia_csvs <- function(csv_dir) {
  csv_files <- list.files(csv_dir, pattern = "\\.csv$", full.names = TRUE)
  
  if (length(csv_files) == 0) {
    stop("No CSV files found in the specified directory.")
  }
  
  all_data <- list()
  
  for (csv_path in csv_files) {
    message("Reading: ", basename(csv_path))
    data_name <- tools::file_path_sans_ext(basename(csv_path))
    all_data[[data_name]] <- read.csv(csv_path)
  }
  
  return(all_data)  # Return a named list of data frames
}
ntia_datasets <- read_ntia_csvs(csv_dir = unzipped_folder)

clean_ntia_data <- function(dataset_list, na_value = -1) {
  cleaned_list <- lapply(dataset_list, function(df) {
    df[is.na(df)] <- na_value
    return(df)
  })
  return(cleaned_list)
}
ntia_datasets <- clean_ntia_data(ntia_datasets)

library(dplyr)

select_covars <- function(datasets, columns_to_select_list) {
  selected_data <- list()
  
  for (dataset_name in names(datasets)) {
    df <- datasets[[dataset_name]]
    
    if (dataset_name %in% names(columns_to_select_list)) {
      cols_wanted <- columns_to_select_list[[dataset_name]]
      available_cols <- intersect(cols_wanted, names(df))
      
      if (length(available_cols) == 0) {
        warning("No matching columns found for ", dataset_name)
        selected_data[[dataset_name]] <- df  # return full df if no matching columns
      } else {
        selected_data[[dataset_name]] <- dplyr::select(df, all_of(available_cols))
      }
    } else {
      # If no selection provided for this dataset, keep full dataset
      selected_data[[dataset_name]] <- df
    }
  }
  
  return(selected_data)
}

count_ntia_rows <- function(dataset_list) {
  row_counts <- sapply(dataset_list, nrow)
  print(row_counts)
  return(row_counts)
}

columns_to_select_list <- list(
    "jul11-cps" = c("hryear4","pesci1","pesc2a6","pelapt","petabl", "pegame","petvba","pehome","pewrka","peschl",
                    "peliba","peotha","peprim1","ptprim2","pepr3a2","peprim6","peprim7","peprim8","peprim9",
                    "peprim10","peprim11","peprim12","peprm141","peprm142","peprm143","peprm144","peprm145",
                    "peprm146", "peprm147","hesci3","pehome", "pecafe", "peelhs", "pecomm", "pelibr", "pewrka", "peschl","peperscr"
                    ,"hesci6","hesci5"),
    
    "jul13-cps" = c("hryear4","hesci15","hesci11","hesci1","henet2","henet3","henet3a","henet41","henet42","henet43","henet44",
                    "henet45","henet46","henet47","henet7a","henet6a","hesci15","hesci121","hesci122","hesci123","hesci124",
                    "pedesk","pelapt","petabl","pecell","pegame","petvba","peprim1","peperscr",
                    "ptprim2","peprm31","peprm32","peprm33","peprm34","peprm141","peprm142","peprm143","peprm144","peprm145",
                    "peprm146","peprm147","peprm151","peprm153","peprm161","peprm162","peprm163","peprm164","pehome", "pecafe", "peelhs",
                    "pecomm", "pelibr", "pewrka", "peschl","hesc2a9","hesc2a8","hesc2a7","hesc2a10","hesc2a11","hesc2a6","hesc2a5","hesc2a4","hesci124"
                    ,"peprm35","peprm36","peprm37","peprm38","peprm39","peprm310","peprm311","peprm312","peprm313","peprm314","peprm315","peprm316","peprm317","peprim12"),
    
    "jul15-cps" = c("hryear4","helaptop", "hedesktp", "hetablet", "hemphone", "hewearab", "hetvbox",
                    "heinhome","heinschl","heincafe","heintrav","heinlico","heinelho", "heinwork", "peinhome", "peinwork","peemail", "petextim", "petelewk", "heevrout", "peincafe", "peinschl", "peinothr",
                    "pegames", "pevideo","pecybuly", "hecbully","peprivacy", "hepspre1","henohm1","henohm2","henohm3","henohm4","henohm5","henohm6","henohm7","henohm8","henohm9","henohm10","henohm11",
                    "henoou1","henoou2","henoou3","henoou4","henoou5","henoou6","henoou7","henoou8","henoou9","henoou10","henoou11"),
    
    "nov17-cps" = c("hryear4","hedesktp", "helaptop", "hetablet", "hemphone", "hewearab", "hetvbox",
                    "heinhome","heinwork", "heinschl", "heincafe", "heintrav", "heinlico", "heinelho", "heinothr",
                    "peemail", "petextim", "pesocial", "peconfer", "pevideo", "peaudio", "pepublish",
                    "petelewk", "pejobsch", "peedtrai", "peusesvc",
                    "hepspre1", "hepspre2", "hepspre3", "hepspre4", "hepspre5","hecbully", "hepscon1", "hepscon2", "hepscon3",
                    "hehomsu", "hepsensi","henohm1","henohm2","henohm3","henohm4","henohm5","henohm6","henohm7","henohm8","henohm9","henohm10", 
                    "heprinoh", "prnohs", "heevrout","henoou1","henoou2","henoou3","henoou4","henoou5","henoou6","henoou7","henoou8","henoou9","henoou10", "heprinoo", "noous"),
    
    "nov19-cps" = c("hryear4","hedesktp", "helaptop", "hetablet", "hemphone", "hewearab", "hetvbox",
                    "heinhome", "heinwork", "heinschl", "heincafe", "heinlico", "heintrav", "heinelho", "heinothr",
                    "peemail", "petextim", "pesocial", "peconfer", "pevideo", "peaudio", "pepublish", "petelewk", "pejobsch",
                    "hecbully", "hepspre1", "henoou7", "henoou8"),
    
    "nov21-cps" = c("hryear4","hedesktp","helaptop","hetablet","hemphone","hewearab","hetvbox",
                    "heinhome", "heinwork", "heinschl", "heincafe", "heinlico", "heintrav", "heinelho", "heinothr",
                    "peemail","petextim","pesocial","pegaming","peconfer","pevideo",
                    "peaudio","pepublish","hehomte1","hehomte2","hehomte3","hehomte4","henetql","henetst",
                    "hepscon1","hepscon2","hepscon3","hepscon4","hepscon5","hepscon6","hepscon7","hepscon8",
                    "hepscyba","hedevqua","hedevsta","henetchk" ,"hemobdat"),
    
    "nov23-cps" = c("hryear4","helaptop", "hedesktp", "hetablet", "hemphone", "hewearab", "hetvbox",
                    "peemail", "petextim", "pesocial", "pegaming", "peconfer", "pevideo", "peaudio", "pepublish", "petelewk",
                    "pejobsch","peedtrai","pegovts","peusesvc","peesrvcs","peecomme","peegoods","pevoicea","pehomiot","hemedrec","hemeddoc",
                    "hepspre1","hepspre2","hepspre3","hepspre4","hepspre5",
                    "hehomte1","hehomte2","hehomte3","hehomte4", "heinhome", "heinwork", "heinschl", "heincafe", "heinlico",
                    "heintrav", "heinelho", "heinothr", "henetql", "henetst","henetchk",
                    "henohm1","henohm2","henohm3","henohm4","henohm5","henohm6","henohm7","henohm8","henohm9","henohm10",
                    "hepscon1","hepscon2","hepscon3","hepscon4","hepscon5","hepscon6","hepscon7","hepscon8",
                    "hepscyba","heinhome","heinwork", "heinschl", "heincafe", "heintrav", "heinlico", "heinelho",
                    "heinothr","henetchk","helaptop", "hedesktp", "hetablet", "hemphone", "hewearab", "hetvbox",
                    "peemail", "petextim", "pesocial", "pegaming", "peconfer", "pevideo", "peaudio", "petelewk",
                    "hehnetql","hehomte3","hehomte2","hehomte1","hehmint",
                    "hemobdat","henetchk"),
    
    "oct03-cps" = c("hryear4", "hesc1","hesint1","hesint2a","hesevr", "hesint5a","pesch","peschw","pesch2","pesch2na","prnet2","prnet3",
                    "prnet1","pesch7","pesnetd", "pesnetb","pesneti", "pesch5","pesch6","sch5","sch6","hescon2",
                    "hesint6","hesint6f","hescon1","hescon2"),
    
    "oct07-cps" = c("hryear4","henet1", "penet2", "henet3", "henet4"),
    
    "oct09-cps" = c("hryear4","henet1","penet2","henet3","henet4","henet5"),
    
    "sep01-cps" = c("hryear4","hesc1","hesc2","hesc3","hesc4","hesint1","hesint2a","hesint41","hesint42","hesint43","hesint44",
                    "prnet1", "prnet2", "prnet3","hescon1",
                    "pesnetsw", "pesnetsx", "pesnetsy", "pesnetsz",
                    "sneta", "snetb", "snetc", "snetd", "snete", "snetf", "snetg", "sneth", "sneti", "snetj", "snetk", "snetl", "snetm", "snetn", "sneto", "snetp", "snetq",
                    "pesch", "peschw", "sch5", "sch6", "sch7",
                    "hescon2", "hesint5a")
  )

# Select specific covariates
ntia_selected <- select_covars(ntia_datasets, columns_to_select_list)
ntia_selected <- ntia_selected[order(as.numeric(gsub("\\D", "", names(ntia_selected))))]
row_counts <- count_ntia_rows(ntia_selected)

standardize_columns <- function(df, all_columns, filler = -1) {
  missing_cols <- setdiff(all_columns, names(df))
  for (col in missing_cols) {
    df[[col]] <- filler
  }
  # Reorder to match all_columns
  df <- df[, all_columns]
  return(df)
}

all_columns <- unique(unlist(lapply(ntia_selected, names)))

standardized_list <- lapply(ntia_selected, standardize_columns, all_columns = all_columns)
merged_ntia <- do.call(rbind, standardized_list)


library(dplyr)
count_ones <- function(data, column_name) {
  column_sym <- ensym(column_name)
  data %>%
    filter(!!column_sym == 1) %>%
    summarise(count = n()) %>%
    pull(count)
}
total_computers_count <- function(data, variable_name) {
  variable_sym <- rlang::sym(variable_name)
  
  total <- data %>%
    mutate(num_computers = as.numeric(!!variable_sym)) %>%
    filter(num_computers > 0) %>%
    summarise(total = sum(num_computers)) %>%
    pull(total)
  
  return(total)
}
summarise_parent_concern <- function(data, variable_name) {
  variable_sym <- rlang::sym(variable_name)
  
  data %>%
    mutate(parent_concern = recode(!!variable_sym,
                                   `1` = "More concerned",
                                   `2` = "Less concerned",
                                   `3` = "About the same",
                                   .default = NA_character_)) %>%
    count(parent_concern, sort = TRUE)
}
count_positive_computers <- function(data, variable_name) {
  variable_sym <- rlang::sym(variable_name)
  
  data %>%
    mutate(num_computers = as.numeric(!!variable_sym)) %>%
    filter(num_computers > 0) %>%
    summarise(count = n()) %>%
    pull(count)
}
count_internet_users <- function(data) {
  sum(data$peprim1 %in% 1:5, na.rm = TRUE)
}




data_01 <- subset(merged_ntia, hryear4 == 2001)
net_user_2001 <- count_ones(data_01, hesint1)

data_03 <- subset(merged_ntia, hryear4 == 2003)
net_user_2003 <- count_ones(data_03, hesint1)

data_07 <- subset(merged_ntia, hryear4 == 2007)
net_user_2007 <- count_ones(data_07, henet1)

data_09 <- subset(merged_ntia, hryear4 == 2009)
net_user_2009 <- count_ones(data_09, henet1)

data_11 <- subset(merged_ntia, hryear4 == 2011)
cols_to_check <- c("hesci6", "hesci5")
net_user_2011 <- ifelse(rowSums(data_11[, cols_to_check] == 1) >= 1, 1, 2)
net_user_2011 <-  sum(net_user_2011 == 1)

data_13 <- subset(merged_ntia, hryear4 == 2013)
data_13 <- data_13 %>%
  mutate(peprim1 = case_when(
    peprim1 %in% 1:5 ~ 1,
    peprim1 == 6 ~ 2,
    TRUE ~ -1
  ))
data_13 <- data_13 %>%
  mutate(peprim12 = case_when(
    peprim12 %in% 1:3 ~ 1,
    TRUE ~ peprim12  # keep all other values as-is
  ))

cols_to_check <- c("henet3","henet2","henet3a","peprim1","pedesk","pelapt","petabl",
                   "pecell","pegame","petvba","pehome", "pecafe", "peelhs", "pecomm", 
                   "pelibr", "pewrka", "peschl","peperscr","hesci1","hesci11","peprim12")
net_user_2013 <- ifelse(rowSums(data_13[, cols_to_check] == 1) >= 1, 1, 2)
net_user_2013 <- sum(net_user_2013 == 1)
net_user_2013


data_15 <- subset(merged_ntia, hryear4 == 2015)
cols_to_check <- c("heinhome","heinschl","heincafe","heintrav","heinlico","heinelho", "heinwork",
                   "helaptop", "hedesktp", "hetablet", "hemphone", "hewearab", "hetvbox")
net_user_2015 <- ifelse(rowSums(data_15[, cols_to_check] == 1) >= 1, 1, 2)
net_user_2015 <-  sum(net_user_2015 == 1)

data_17 <- subset(merged_ntia, hryear4 == 2017)
cols_to_check <- c("heinhome","heinwork", "heinschl", "heincafe", "heintrav", "heinlico", "heinelho", "heinothr","helaptop", "hedesktp", "hetablet", "hemphone", "hewearab", "hetvbox")
net_user_2017 <- ifelse(rowSums(data_17[, cols_to_check] == 1) >= 1, 1, 2)
net_user_2017 <-  sum(net_user_2017 == 1)

data_19 <- subset(merged_ntia, hryear4 == 2019)
cols_to_check <- c("heinhome","heinwork", "heinschl", "heincafe", "heintrav", "heinlico", "heinelho",
                   "heinothr","helaptop", "hedesktp", "hetablet", "hemphone", "hewearab", "hetvbox",
                   "peemail", "petextim", "pesocial", "peconfer", "pevideo", "peaudio", "petelewk")
net_user_2019 <- ifelse(rowSums(data_19[, cols_to_check] == 1) >= 1, 1, 2)
net_user_2019 <-  sum(net_user_2019 == 1)

data_21 <- subset(merged_ntia, hryear4 == 2021)
cols_to_check <- c("hedesktp","helaptop","hetablet","hemphone","hewearab","hetvbox",
                   "heinhome", "heinwork", "heinschl", "heincafe", "heinlico", "heintrav", "heinelho", "heinothr")
net_user_2021 <- ifelse(rowSums(data_21[, cols_to_check] == 1) >= 1, 1, 2)
net_user_2021 <-  sum(net_user_2021 == 1)

data_23 <- subset(merged_ntia, hryear4 == 2023)
cols_to_check <- c("heinhome","heinwork", "heinschl", "heincafe", "heintrav", "heinlico", "heinelho",
                   "heinothr","henetchk","helaptop", "hedesktp", "hetablet", "hemphone", "hewearab", "hetvbox")
net_user_2023 <- ifelse(rowSums(data_23[, cols_to_check] == 1) >= 1, 1, 2)
net_user_2023 <-  sum(net_user_2023 == 1)




observed <- c("net_user_2001","net_user_2003","net_user_2007","net_user_2009","net_user_2011","net_user_2013","net_user_2015"
             ,"net_user_2017","net_user_2019","net_user_2021","net_user_2023")
observed_val <- c(net_user_2001,net_user_2003,net_user_2007,net_user_2009,net_user_2011,net_user_2013,net_user_2015
              ,net_user_2017,net_user_2019,net_user_2021,net_user_2023)
named_values <- setNames(observed_val,observed)
net_users_counts <- data.frame(
  internet_user_content = names(named_values),
  internet_user_values = as.numeric(named_values),
  stringsAsFactors = FALSE
)
net_users_counts$year <- as.numeric(sub("net_user_", "", net_users_counts$internet_user_content))

row_counts_df <- data.frame(
  cps = names(row_counts),
  total = as.integer(row_counts)
)

# Extract 2-digit year and convert to 4-digit year
row_counts_df$year <- as.integer(
  ifelse(
    as.integer(sub(".*([0-9]{2})-cps", "\\1", row_counts_df$cps)) < 50,
    paste0("20", sub(".*([0-9]{2})-cps", "\\1", row_counts_df$cps)),
    paste0("19", sub(".*([0-9]{2})-cps", "\\1", row_counts_df$cps))
  )
)

# Merge the data frames by year
net_table <- merge(net_users_counts, row_counts_df, by = "year")

# Calculate percentage
net_table$percent <- (net_table$internet_user_values / net_table$total) * 100

# View result
net_table

# Load ggplot2 for plotting
library(ggplot2)

# Line plot
ggplot(net_table, aes(x = year, y = percent)) +
  geom_line() +
  geom_point() +
  labs(title = "Percentage Of Households That Use Internet Over Time",
       x = "Year",
       y = "Percentage of Households") +
  theme_minimal()





comp_user_2001 <- count_ones(data_01, "hesc1")

comp_user_2003 <- count_ones(data_03, "hesc1")

comp_user_2011 <- count_positive_computers(data_11, "hesci3")

cols_to_check <- c("henet3","henet2","peprim1","pedesk","pelapt","petabl","pecell","pegame","petvba",
                   "pehome", "pecafe", "peelhs", "pecomm","pelibr", "pewrka", "peschl","hesci1")
comp_user_2013 <- ifelse(rowSums(data_13[, cols_to_check] == 1) >= 1, 1, 2)
comp_user_2013 <- sum(comp_user_2013 == 1)

cols_to_check <- c("helaptop", "hedesktp", "hetablet", "hemphone", "hewearab", "hetvbox")
comp_user_2015 <- ifelse(rowSums(data_15[, cols_to_check] == 1) >= 1, 1, 2)
comp_user_2015 <-  sum(comp_user_2015 == 1)

cols_to_check <- c("helaptop", "hedesktp", "hetablet", "hemphone", "hewearab", "hetvbox")
comp_user_2017 <- ifelse(rowSums(data_17[, cols_to_check] == 1) >= 1, 1, 2)
comp_user_2017 <-  sum(comp_user_2017 == 1)

cols_to_check <- c("helaptop", "hedesktp", "hetablet", "hemphone", "hewearab", "hetvbox")
comp_user_2019 <- ifelse(rowSums(data_19[, cols_to_check] == 1) >= 1, 1, 2)
comp_user_2019 <-  sum(comp_user_2019 == 1)

cols_to_check <- c("hedesktp","helaptop","hetablet","hemphone","hewearab","hetvbox")
comp_user_2021 <- ifelse(rowSums(data_21[, cols_to_check] == 1) >= 1, 1, 2)
comp_user_2021 <-  sum(comp_user_2021 == 1)

data_23 <- ntia_selected[["nov23-cps"]]
cols_to_check <- c("helaptop", "hedesktp", "hetablet", "hemphone", "hewearab", "hetvbox")
comp_user_2023 <- ifelse(rowSums(data_23[, cols_to_check] == 1) >= 1, 1, 2)
comp_user_2023 <-  sum(comp_user_2023 == 1)



observed <- c("comp_user_2001","comp_user_2003","comp_user_2011","comp_user_2013","comp_user_2015"
              ,"comp_user_2017","comp_user_2019","comp_user_2021","comp_user_2023")
observed_val <- c(comp_user_2001,comp_user_2003,comp_user_2011,comp_user_2013,comp_user_2015
                  ,comp_user_2017,comp_user_2019,comp_user_2021,comp_user_2023)
named_values <- setNames(observed_val,observed)
comp_users_counts <- data.frame(
  computer_user_content = names(named_values),
  computer_user_values = as.numeric(named_values),
  stringsAsFactors = FALSE
)
comp_users_counts$year <- as.numeric(sub("comp_user_", "", comp_users_counts$computer_user_content))

row_counts_df <- data.frame(
  cps = names(row_counts),
  total = as.integer(row_counts)
)

# Extract 2-digit year and convert to 4-digit year
row_counts_df$year <- as.integer(
  ifelse(
    as.integer(sub(".*([0-9]{2})-cps", "\\1", row_counts_df$cps)) < 50,
    paste0("20", sub(".*([0-9]{2})-cps", "\\1", row_counts_df$cps)),
    paste0("19", sub(".*([0-9]{2})-cps", "\\1", row_counts_df$cps))
  )
)

# Merge the data frames by year
comp_table <- merge(comp_users_counts, row_counts_df, by = "year")

# Calculate percentage
comp_table$percent <- (comp_table$computer_user_values / comp_table$total) * 100
comp_table

# Load ggplot2 for plotting
library(ggplot2)

# Line plot
ggplot(comp_table, aes(x = year, y = percent)) +
  geom_line() +
  geom_point() +
  labs(title = "Percentage Of Households That Use Device Over Time",
       x = "Year",
       y = "Percentage of Households") +
  theme_minimal()
```
